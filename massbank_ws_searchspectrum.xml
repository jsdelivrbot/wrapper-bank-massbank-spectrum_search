<tool id="massbank_ws_searchspectrum" name="MassBank spectrum searches" version="2016-02-19">
  <description>
       : Search by pseudo-spectra on a High Quality Mass Spectral Database.
  </description>
  
  <requirements>
  <!-- Waiting for conda improvement in Galaxy
      <requirement type="package" version="1.19">perl-soap-lite</requirement>
      <requirement type="package" version="6.15">perl-lwp-simple</requirement>
	  <requirement type="package" version="6.15">perl-libwww-perl</requirement>
      <requirement type="package" version="2.95">perl-html-template</requirement>
      <requirement type="package" version="1.71">perl-uri</requirement>
      <requirement type="package" version="1.33">perl-text-csv</requirement>
  -->
  </requirements>
  
  <stdio>
      <exit_code range="1" level="fatal" />
  </stdio>
  
  <command><![CDATA[
    perl $__tool_directory__/massbank_ws_searchspectrum.pl
      -masses "${variableMetadata_in}"
      #if str($header.header_choice) == "True":
        -lineheader "${header.nbheader}"
      #end if
      -col_mz "$col_mass" -col_pcgroup "$col_pcgroup" -score_threshold "$score_threshold"
      #if str($intensity.colint_choice) == "True":
        -col_int "${intensity.col_int}"
      #end if
      #if str($mode) == "Positive,Negative":
        -mode "both"
      #else:
        -mode "$mode"
      #end if
      
      #if str($advanced.advanced_settings) == "False":
        -instruments "all" -max "10" -unit "unit" -tolerance "0.3" -cutoff "50" -server "JP"
      #else:
        -instruments "${advanced.instruments}" -max "${advanced.max}"
        -unit "${advanced.mz_tolerance.unit}" -tolerance "${advanced.mz_tolerance.tolerance}"
        -cutoff "${advanced.cutoff}" -server "${advanced.server}"
      #end if

      -output_tabular "$variableMetadata"
      -output_xlsx "$massBankSpectraOutXlsx"
      -output_json "$massBankSpectraOutJson"
      -output_html "$massBankSpectraOutWeb"
  ]]></command>
  
  <inputs>
    <param name="variableMetadata_in" label="File of masses (format: tabular)" format="tabular" type="data" help="Generally variable metadata file" />
    <conditional name="header">
      <param name="header_choice" type="boolean" checked="true" truevalue="yes" falsevalue="no" label="Do you have a header?" help="if 'YES' is selected then enter your number of header lines" />
      <when value="yes">
        <param name="nbheader" type="integer" label="Number of header lines" value="1" min="1" max="10" help="number of lines not containing masses"/>
      </when>
      <when value="no"/>
    </conditional>
    <param name="col_mz" label="Column of masses (MZ)" type="data_column" data_ref="variableMetadata_in" accept_default="true" />
    <param name="col_pcgroup" label="Column of pcgroup" type="data_column" data_ref="variableMetadata_in" accept_default="true" />
    <conditional name="intensity">
      <param name="colint_choice" type="boolean" checked="false" truevalue="yes" falsevalue="no" label="Do you have a column of intensity?" help="if 'YES' is selected then indicate your column of intensity" />
      <when value="yes">
        <param name="col_int" label="Column of intensity" type="data_column" data_ref="variableMetadata_in" accept_default="true" />
      </when>
      <when value="no"/>
    </conditional>
    <param name="mode" label="What kind of Ionization Search will be done?" type="select" display="checkboxes" multiple="True" help="">
      <option value="Positive" selected="True">Positif Mode</option>
      <option value="Negative" selected="True">Negatif Mode</option>
    </param>
    <param name="score_threshold" label="Score threshold to apply on returned MassBank results" type="float" value="0.5" min="0" max="1" help="Default value is 0.5."/>
    <conditional name="advanced">
      <param name="advanced_settings" type="boolean" checked="false" truevalue="yes" falsevalue="no" label="Show advanced settings?" help="if 'NO' is selected then defaults values are: instruments => all ; max => 10 ; unit => unit ; tolerance => 0.3 ; cutoff => 50 ; server => JP" />
      <when value="yes">
        <param name="instruments" label="What kind of Instruments will be use?" type="select" display="checkboxes" multiple="True" help="">
          <option value="all">All</option>
          <option value="APCI-ITFT">APCI-ITFT</option>
          <option value="APCI-ITTOF">APCI-ITTOF</option>
          <option value="CE-ESI-TOF">CE-ESI-TOF</option>
          <option value="CI-B">CI-B</option>
          <option value="EI-B">EI-B</option>
          <option value="EI-EBEB">EI-EBEB</option>
          <option value="ESI-ITFT">ESI-ITFT</option>
          <option value="ESI-ITTOF">ESI-ITTOF</option>
          <option value="FAB-B">FAB-B</option>
          <option value="FAB-EB">FAB-EB</option>
          <option value="FAB-EBEB">FAB-EBEB</option>
          <option value="FD-B">FD-B</option>
          <option value="FI-B">FI-B</option>
          <option value="GC-EI-QQ">GC-EI-QQ</option>
          <option value="GC-EI-TOF">GC-EI-TOF</option>
          <option value="LC-APCI-QTOF">LC-APCI-QTOF</option>
          <option value="LC-APPI-QQ">LC-APPI-QQ</option>
          <option value="LC-ESI-IT">LC-ESI-IT</option>
          <option value="LC-ESI-ITFT">LC-ESI-ITFT</option>
          <option value="LC-ESI-ITTOF">LC-ESI-ITTOF</option>
          <option value="LC-ESI-Q">LC-ESI-Q</option>
          <option value="LC-ESI-QFT">LC-ESI-QFT</option>
          <option value="LC-ESI-QIT">LC-ESI-QIT</option>
          <option value="LC-ESI-QQ">LC-ESI-QQ</option>
          <option value="LC-ESI-QTOF">LC-ESI-QTOF</option>
          <option value="LC-ESI-TOF">LC-ESI-TOF</option>
          <option value="MALDI-QIT">MALDI-QIT</option>
          <option value="MALDI-TOF">MALDI-TOF</option>
          <option value="MALDI-TOFTOF">MALDI-TOFTOF</option>
        </param>
        <param name="max" type="integer" label="Maximum number of search results" value="10" min="0" max="50" help="'0' means unspecified and then all results are obtained."/>
        <conditional name="mz_tolerance">
          <param name="unit" label="Unit of tolerance" type="select" display="radio" help="">
            <option value="unit" selected="True">unit</option>
            <option value="ppm">ppm</option>
          </param>
          <when value="unit">
            <param name="tolerance" label="Tolerance of values of m/z of peaks (in unit)" type="float" value="0.3" min="0" max="10" help="Default value is 0.3 unit."/>
          </when>
          <when value="ppm">
            <param name="tolerance" label="Tolerance of values of m/z of peaks (in ppm)" type="integer" value="50" min="0" max="5000" help="Default value is 50 ppm."/>
          </when>
        </conditional>
        <param name="cutoff" label="Ignore peaks whose intensity is not larger than the value of cutoff" type="integer" value="50" min="0" max="5000000" help="Ignore peaks whose intensity is not larger than the value of cutoff."/>
        <param name="server" label="Which MassBank server start searching?" type="select" display="radio" help="">
          <option value="JP" selected="True">Japon (JP)</option>
          <option value="EU">Europe (EU)</option>
        </param>
      </when>
      <when value="no"/>
    </conditional>
  </inputs>
  
  <outputs>
    <data name="variableMetadata" label="${input_type.masses.name[:-6]}.MASSBANK.tabular" format="tabular" />
    <data name="massBankSpectraOutWeb" format="html" label="${input_type.masses.name[:-6]}.MASSBANK_WEB.html" />
    <data name="massBankSpectraOutXlsx" label="${input_type.masses.name[:-6]}.MASSBANK_XLS.txt" format="tabular" />
    <data name="massBankSpectraOutJson" label="${input_type.masses.name[:-6]}.MASSBANK_JSON.txt" format="txt" />
  </outputs>
  
  <tests>
  	<test>
  		<!--test 01 short result -  -->
  		<param name="masses" value="input01_69-pcgroups-mz-relative_int.tabular"/>
  		<param name="header_choice" value="yes"/>
  		<param name="nbheader" value="1"/>
  		<param name="col_mz" value="1"/>
  		<param name="col_pcgroup" value="14"/>
  		<param name="colint_choice" value="yes"/>
  		<param name="col_int" value="7"/>
  		<param name="mode" value="Positive"/>
  		<param name="score_threshold" value="0.5"/>
  		<param name="advanced_settings" value="yes"/>
  		<param name="instruments" value="all"/>
  		<param name="max" value="20"/>
  		<param name="unit" value="unit"/>
  		<param name="tolerance" value="0.3"/>
  		<param name="cutoff" value="50"/>
  		<param name="server" value="JP"/>
  		
  		<output name="variableMetadata" file="out_test01.tabular"/>
  		<output name="massBankSpectraOutWeb" file="out_test01.html"/>
  		<output name="massBankSpectraOutXlsx" file="out_test01.txt"/>
  		<output name="massBankSpectraOutJson" file="out_test01.json"/>
  	</test>
  	<test>
  		<!--test 02 : lot of results - 3 columns file-->
  	</test>
  	<test>
  		<!--test 03 : fake results - with high threshold -->
  	</test>
  </tests>

  <help><![CDATA[

.. class:: infomark

**Wrapping**
  | Franck Giacomoni - PFEM ; INRA ; MetaboHUB (for xml interface and perl wrapper and WS client)

---------------------------------------------------

.. class:: infomark

**Please cite** If you use this tool, please cite MassBank.

for `MassBank. &lt;http://www.massbank.jp&gt;`_ :
  `H. Horai, M. Arita, S. Kanaya, Y. Nihei, T. Ikeda, K. Suwa. Y. Ojima, K. Tanaka, S. Tanaka, K. Aoshima, Y. Oda, Y. Kakazu, M. Kusano, T. Tohge, F. Matsuda, Y. Sawada, M. Yokota Hirai, H. Nakanishi, K. Ikeda, N. Akimoto, T. Maoka, H. Takahashi, T. Ara, N. Sakurai, H. Suzuki, D. Shibata, S. Neumann, T. Iida, K. Tanaka, K. Funatsu, F. Matsuura, T. Soga, R. Taguchi, K. Saito and T. Nishioka, (2010). "MassBank: A public repository for sharing mass spectral data for life sciences." J. Mass Spectrom., 45, 703-714. &lt;http://www.ncbi.nlm.nih.gov/pubmed/20623627&gt;`_

      <!-- [RECOMMANDED] All citations associated to this tool (main citation given above and other references). Can be extracted from the history panel -->
    <citations>
        <citation type="doi">10.1002/jms.1777</citation>
    </citations>

==============
wsdl_MassBank
==============

-----------
Description
-----------

Finding information (search spectra method) in the MassBank project via a web service from masses and pcgroups.

-----------------
Workflow position
-----------------


.. image:: ./static/images/metabolomics/massbank-ws.png
        :width: 800


-----------
Input files
-----------

+-------------------------+-----------+
| Parameter : num + label |  Format   |
+=========================+===========+
| 1 : variableMetadata    |  tabular  |
+-------------------------+-----------+

File variableMetadata must have at least the 2 following column : 
	* Masses : column with all the masses in the tabular input file
	* Intensities : column with all the intensities in the tabular input file (Optionnal)
	* PCgroups : column with all the pcgroups in the tabular input file


----------
Parameters
----------

Number of header lines
	| Number of lines not containing values 
	|

Column of masses
	| Specify the column number for the mass in the tabular input file
	|

Tolerance of mass (in unit or ppm)
	| Specify a delta (+/-) to the mass to search
	
Parameters applied on query
	| cutoff : intensity cutoff (don't add to the query, mz with intensity below defined cutoff).
	| max: maximum number of records returned by the MASSBANK server foreach pcgroup of masses (by default max is set to 10).
	| score_threshold: apply a filter on MASSBANK scores (by default threshold is set to 0.5).
	| mode : Ionization search mode: Positive or Negative ou Both
	| Instrument: filter applied on spectra depending of the instrument source. (All is the default value) - - GCMS technologies are available in W4M GCMS tools section.

------------
Output files
------------

Two types of files
	| MASSBANK_WEB.html: for viewing result via HTML.
	| MASSBANK.tabular: for linking with others modules.
	| MASSBANK_XLS.txt: an excel-like output to export results under a multi lines format.
	| MASSBANK_JSON.txt: an json output will be available.
	
---------------------------------------------------


---------------
Working example
---------------


.. class:: warningmark

Refer to the corresponding W4M HowTo section: http://workflow4metabolomics.org/howto
 | Format Data For Postprocessing
 | Perform LCMS Annotations

.. class:: warningmark

And their "W4M courses 2016":
 | Using Galaxy4Metabolomics - W4M table format for Galaxy
 | Annotation Banks - Annotation  
	
	]]></help>
</tool>